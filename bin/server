#!/usr/bin/env node

var version = require('../package.json').version,
    program = require('commander'),
    Docker = require('dockerode'),
    Connection = require('../lib/connection'),
    utils = require('../lib/utils');

program
    .version(version)
    .option('-e, --endpoint <url>', 'Docker API url')
    .option('-r, --repository <name> (default: grounds)', 'Docker repository')
    .option('-p, --port <number> (default: 8080)', 'Port to serve')
    .parse(process.argv);

if (!program.endpoint) {
    console.log('Please specify a valid docker API url.');
    return program.help();
}

var repository = program.repository || 'grounds',
    port       = program.port || 8080,
    dockerHost = utils.formatDockerHost(program.endpoint),
    docker     = new Docker(dockerHost);

docker.ping(function(err, data) {
    if (err) {
        console.log('Docker API not responding.');
        process.exit(1);
    }
});

docker.repository = repository;

console.log('Using docker host: ', dockerHost);
console.log('Using docker repository: %s', repository);
console.log('Listening on: %d', port);

var io = require('socket.io').listen(port);

io.on('connection', function (socket) {
    console.log('New connection.');
    new Connection(socket, docker).bindEvents();
}).on('disconnect', function() {
    console.log('A client has disconnected.');
});
